# Changelog

## v2.0.0 (2025-02-16)

### 重大更新 🎉

本次更新全面覆盖微信公众号API核心功能，从6个工具扩展到15个工具，新增9个功能模块，打造最完整的微信公众号MCP服务。

### 新增功能模块

#### 1. 用户管理 (`wechat_user`)
- 获取用户列表（支持分页）
- 获取用户基本信息（支持UnionID）
- 批量获取用户信息（最多100个）
- 设置用户备注名
- 获取用户增减数据统计
- 获取累计用户数据统计

#### 2. 标签管理 (`wechat_tag`)
- 创建、编辑、删除标签
- 批量为用户打标签/取消标签
- 获取标签下用户列表
- 支持用户分组和精准营销

#### 3. 自定义菜单 (`wechat_menu`)
- 创建、查询、删除自定义菜单
- 支持个性化菜单（基于标签、性别、地区等）
- 获取菜单配置信息
- 支持多种菜单类型（click、view、扫码等）

#### 4. 模板消息 (`wechat_template_msg`)
- 发送模板消息
- 获取模板列表
- 删除模板
- 获取账号所属行业信息
- 支持自定义颜色和跳转链接

#### 5. 客服消息 (`wechat_customer_service`)
- 发送文本、图片、语音、视频、音乐、图文消息
- 获取客服聊天记录
- 支持48小时内主动回复
- 支持多种媒体类型

#### 6. 数据统计分析 (`wechat_statistics`)
- 图文数据统计（阅读、分享、收藏）
- 消息数据统计（发送概况）
- 接口分析数据（调用次数、失败率、耗时）
- 用户增减数据统计
- 支持日统计和分时统计

#### 7. 自动回复规则 (`wechat_auto_reply`)
- 查询关注后自动回复
- 查询消息自动回复
- 查询关键词自动回复
- 获取当前自动回复配置

#### 8. 群发消息 (`wechat_mass_send`)
- 根据标签群发消息
- 根据OpenID列表群发
- 支持图文、文本、图片、语音、视频、卡券
- 删除群发消息
- 预览群发消息
- 支持群发全部用户或指定标签

#### 9. 订阅通知 (`wechat_subscribe_msg`)
- 发送一次性订阅通知
- 支持小程序跳转
- 支持自定义模板数据

### 技术改进

- **API Client 扩展**: 从 6 个 API 方法扩展到 60+ 个方法
- **完整的类型定义**: 所有新增API都有完整的TypeScript类型定义
- **统一的错误处理**: 所有新工具遵循统一的错误处理和日志规范
- **参数验证**: 使用Zod进行严格的输入参数验证
- **代码组织**: 新增9个工具文件，代码结构清晰

### 文档更新

- 新增 `API_FEATURES_ANALYSIS.md` - 详细的功能分析与规划文档
- 新增 `FEATURE_IMPLEMENTATION_GUIDE.md` - 快速实现指南
- 更新 `README.md` - 完整的15个工具使用说明
- 更新 `CLAUDE.md` - 架构和开发规范

### 安全增强

- 保持所有安全特性（加密存储、日志脱敏、CORS配置）
- 新增工具同样遵循安全最佳实践
- 输入验证和输出过滤

### 破坏性变更

无破坏性变更，所有新功能都是新增的，不影响现有功能。

### 升级建议

1. **测试环境验证**: 建议先在测试环境验证所有新功能
2. **API权限检查**: 部分功能需要特定的公众号权限（如认证服务号）
3. **配置检查**: 确保环境变量正确配置（`CORS_ORIGIN`、`WECHAT_MCP_SECRET_KEY`）
4. **文档阅读**: 阅读新功能文档了解使用方法

### 2025年重要提醒

⚠️ **自2025年7月起**：
- 个人账号将失去API发布权限
- 未认证企业账号将失去API权限
- 建议使用已认证的服务号进行开发

### 下一步计划

- [ ] 添加单元测试和集成测试
- [ ] 添加更详细的使用示例
- [ ] 优化错误提示信息
- [ ] 添加性能监控和日志分析

---

## v1.1.0 (2025-11-19)

### 新增
- MCP 模式认证工具 `wechat_auth` 支持 `configure/get_token/refresh_token/get_config`
- CLI 版本号动态读取 `package.json`
- SSE 传输支持环境变量 `CORS_ORIGIN` 配置跨域来源

### 修复
- 修复 `wechat_media_upload` 在保存素材时未初始化数据库的问题，并统一创建时间为毫秒
- 修复 Express 错误处理中间件签名，确保被框架正确识别与捕获

### 安全
- 为 `app_secret/token/encoding_aes_key/access_token` 引入可选 AES 加密持久化（设置 `WECHAT_MCP_SECRET_KEY` 即启用）
- 微信 API 客户端错误日志脱敏：仅记录状态码或错误消息，避免泄露响应体
- CORS 来源可配置，建议生产环境设置白名单域名

### 改进
- 统一工具与客户端的错误日志输出格式，提升可读性与合规性

### 升级指南
- 强烈建议在生产环境配置：
  - `WECHAT_MCP_SECRET_KEY`：启用敏感字段加密存储
  - `CORS_ORIGIN`：逗号分隔白名单域名（如 `https://a.example.com,https://b.example.com`）
- 临时素材 `createdAt` 统一为毫秒时间戳，无需额外迁移；旧记录不受影响

---

## v1.0.3 (2025-11-19)
- 初始版本（发布至 npm，基础 MCP 工具与前端结构）